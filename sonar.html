<?xml version="1.0" encoding="utf-8" ?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
<head>
  <title>Aktuality ze cvičení z C/C++ na FJFI, Wlada</title>
  <link rel="stylesheet" type="text/css" href="styl.css"/>
  <link rel="alternate" type="application/rss+xml" title="RSS" href="akt/rss.xml"/>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <meta name="author" content="Vladimír Klement" />
</head>

<body>

<div id="hlavicka" role="banner">
<h1>Wlada</h1>
<p>wlada(zavináč)post.cz</p>
</div>

<div id="menuHlavni" role="navigation">
<a href="http://kfe.fjfi.cvut.cz/~klement/">Cvičení</a>
<a href="?stranka=SDL_ttf">Tutoriály</a>
<a href="?stranka=kody">Kódy</a>
<a href="?stranka=odkazy">Zbytek</a>
</div>


<div id="menuVedlejsi" role="navigation">
<a href="http://kfe.fjfi.cvut.cz/~klement/">Aktuality</a>
<a href="?stranka=materialy">Materiály</a>
<a href="?stranka=dochazka">Docházka</a>
<a href="?stranka=plan">Zápočet</a>
<a href="?stranka=ukoly">Úkoly</a>
</div> 

<div id="obsah" role="main">
<br/>
<!--- ----------------------------------------Zacatek vlastni dokumentace------------------------------- -->

<h1>Jednoduchý sonar ze zvukovky<br/>Jakub Kákona (kaklik@mlab.cz)</h1>

<p>
Program je demonstrací základních funkcí audio systému ALSA <a href="http://www.alsa-project.org/">http://www.alsa-project.org/</a>. Konkrétně je ukázkou přístupu k zařízení Playback a Capture. A zároveň jednoduchým prostředkem k prozkoumání akustických vlastností různých materiálů pouze pomocí svého počítače. :) 
</p>

<img src="podlaha.png" alt="Obrázek aktivního sonaru"/>

<h2>Závislosti</h2>
<p>
Program je napsán pro OS Linux a testován byl konkrétně na Ubuntu.
</p>

<ul>
<li>Linux</li>
<li>libasound2</li>
</ul>

<p>
K přeložení programu je tedy nutné mít nainstalované vývojové knihovny ALSA (libasound2-dev). Pokud máme splněné všechny závislosti, tak lze program přeložit pomocí gcc s následujícími parametry:
</p>

<pre><code>
gcc sonar.c -o sonar -lasound
</code></pre>

<h2>O co se jedná</h2>
<p>
K funkci program využije mono reproduktorový výstup. A vstup stereofonního mikrofonu. Nejdříve si vygeneruje vzorky pingu do pole, které předá ovladači zvukové karty. Následně připraví a otevře zařízení mikrofonu, aby po jeho otevření mohl spustit oba kanály zvuku současně. Tím dojde k zaznamenání vysílaného signálu i případných odražených ech do pole, které lze pak dále zpracovávat.  
</p>

<h2>Výstup</h2>
<p>
Navzorkovaná a vypočtená data jsou ukládána do textových souborů v adresáři /tmp/ ze kterého je pak možné je vykreslovat pomocí <a href="plot.gp">skriptu</a> Gnuplotu.
V horní části grafu je vysílaný signál. Uprostřed signál navzorkovaný mikrofony a dole výstup po korelaci nasnímaného signálu s odeslaným.
</p>

<pre><code>
~#gnuplot
> load "plot.gp"
</code></pre>

<p>
Skrip si sám cyklicky spouští program "sonar" a překresluje graf. Lze tak experimentovat s odrazy od různých překážek a třeba i pokračovat ve vývoji kódu.
</p>

<h2>Zpracování dat</h2>
<p>
Zpracovaní používá pouze metodu <a href="http://en.wikipedia.org/wiki/Cross-correlation">křížové korelace</a> kterou se porovnají snímané signály vůči původnímu odeslanému pingu. Tím jsou ve výsledku velice zvýrazněna odražená echa. Celý algoritmus jsou následující dva cykly:
</p>

<pre><code>
    for (n=0; n < (period_size - chirp_size - 1); n++)
    {
        l=0;
        r=0;
        for ( m = 0; m < chirp_size;m++)
        {
            l += chirp[m]*L_signal[m+n];	// correlate with left channel
            r += chirp[m]*R_signal[m+n];	// correlate with right channel
        }
        correlationl[n]=abs(l);
        correlationr[n]=abs(r);
    }
</code></pre>

<p> Všechny zdrojové kódy v <a href="sonar.zip">jednom balíku (64bit)</a>
</p>

<h2>Známé chyby a nedodělky</h2>
<dl>
	<dt>Ztráta amplitudy signálu</dt>
		<dd>Takto jednoduchý program neuvažuje ztrátu výkonu signálu při šíření prostředím. Správně by se mělo zvyšovat zesílení vstupu mikrofonů se čtvrtou mocninou času.</dd>
	<dt>Korektní start slinkovaného zařízení</dt>
		<dd>Knihovna ALSA by podle dokumentace měla umět spojit zařízení Capture a Playback do jednoho a zacházet tak pak pouze s jedním zařízením. Toto by bylo zvlášť užitečné pro zlepšení synchronizace vstupu a výstupu. Tato možnost mi ale nefungovala na všech počítačích, proto je v tomto konkrétním kódu zakomentována.</dd>
</dl>
